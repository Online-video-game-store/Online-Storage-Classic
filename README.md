## Магазин игрушек.

Простой pet-проект, выполненный на микросервисной архитектуре.

- `Auth-server` - OAuth2-сервер аутентификации и авторизации.
- `Eureka-server` - устаревший, но пока еще используемый service discovery, для обнаружения и регистрации микросервисов.
- `Gateway-server` - шлюз для доступа к микросервисам из веб-клиента.
- `Service-Cart` - микросервис корзины пользователя.
- `Service-Catalog` - микросервис товаров.
- `Service-Payment` - микросервис для проведения платежей.
- `Service-Order` - микросервис для оформления заказов.
- `Service-Notification` - микросервис рассылки уведомлений пользователям.
- `Web-client` - микросервис веб-клиента.
- `OSC-Commons` - модуль с общими классами dto.

Взаимодействие между микросервисами происходит через `Feign` + `Eureka`. Также используется `RabbitMQ`
для публикации уведомлений.

Все микросервисы, участвующие в обработке заказов, имеют глобальные обработчики ошибок,
возвращающих ошибку в виде класса `ErrorResponse`. Если ошибка возникла
в другом микросервисе, то просто пробрасывают её далее, до получателя.


### Установка контейнеров.

Создаем контейнер с `MySql` и `RabbitMQ`. Для этого из из папки `tools/osc-containers` запускаем:
```shell
docker-compose up -d
```
В файлах `.env.*` заданы переменные окружения для образов, в случае нужды их можно предварительно подправить.


### Переменные окружения.

Микросервисы по умолчанию настроены на запуск на локальной машине. Чтобы запустить на разных, необходимо
создать следующие переменные окружения с адресами серверов:
- OAUTH2_ISSUER_URI - адрес сервера аутентификации.
- OAUTH2_JWK_URI - ${OAUTH2_ISSUER_URI}/oauth2/jwks
- EUREKA_SERVER_URL - адрес сервера Eureka.
- GATEWAY_SERVER_URL - адрес сервера Gateway
- OAUTH2_REDIRECT_URI - адрес переадресации после процедуры аутентификации пользователя (для Web-клиента).

Помимо этого также используются переменные:
GMAIL_PASSWORD - 16-символьный код для gmail-API. Или для другого API почты.
USER_ID_CLAIM - название поля в Jwt-токене, в котором хранится ID пользователя.
ANON_ID_CLAIM - название поля куки, в котором хранится ID анонимного пользователя.

CART_SERVICE_PORT, CATALOG_SERVICE_PORT, ORDER_SERVICE_PORT, NOTIFICATION_SERVICE_PORT, PAYMENT_SERVICE_PORT - номера портов микросервисов, по умолчанию равны нулю (выделяются доступные свободные номера).
WEB_CLIENT_PORT - порт веб-клиента, по умолчанию 9000.


### Аутентификация.

Используется механизм `SpringSecurity` + `OAuth2`. Сервер использует свою БД для
пользователей, позволяя использовать комбинации ролей и прав (scopes).

Используется кастомизация Jwt-Токена:
- В поле `authorities` передаются роли пользователя.
- В поле `scope` соответственно его права.
- В добавленные поля `userId` и `email` соответственно идентификатор и мыло пользователя. Имя хранится в поле `sub`.

Соответственно другие микросервисы имеют фильтры, извлекающие значения из этих полей и помещающие
их в контекст безопасности.

Помимо этого, если для аутентификации используется `client_credentials`, то клиенту присваивается роль `ROLE_SERVICE`.
Эта роль используется для мониторинга микросервисов, то есть для сбора метрик посредством `Prometheus`.


### Gateway.

Обычный шлюз. Запросы из `Prometheus` включают в себя имя микросервиса, под которым он зарегистрирован
в `Eureka`, поэтому шлюз обрезает это имя и направляет запрос по стандартному (для метрик) пути (/actuator/**).


### Корзина.

Данные для анонимных пользователей хранятся в памяти. Для авторизированных - в БД. 
Анонимы идентифицируются через куки (принудительно внедряется Веб-клиентом).

Используется паттерн `Strategy`. Позволяет легко менять стратегию работы с корзиной
для различных типов пользователей (авторизированные и анонимные).


### Order.

Оформление и проведение заказов.

Используется паттерн `Saga`, поскольку позволяет легко задать не только очередность
выполнения действий, но и их откат в обратном порядке, в случае если на каком-то
этапе произойдет ошибка. Сущность `Order` реализована паттерном `Builder`.

В случае успеха, или ошибки, рассылает уведомления посредством `RabbitMQ`.
В уведомление встраивается текущий Jwt-Токен, чтобы приемная сторона
идентифицировала текущего пользователя.


### Notification.

Сервис рассылки уведомлений пользователям. Пока что только по `e-mail`.

Уведомления для рассылки принимает от `RabbitMQ`, извлекает из него Jwt-Токен и по 
извлеченным из него данным настраивает и устанавливает контекст безопасности. После
этого рассылает уведомления всеми доступными способами.

Рассылка мыла идет по 16-символьному коду (получить можно
через: https://myaccount.google.com/apppasswords).


### Web-client.

Обычный OAuth2-клиент. Обеспечивает веб-интерфейс через Thymeleaf и JavaScript.


### Запуск.

Запускаем в порядке очередности:
1. Auth-server.
2. Eureka-server.
3. Gateway-server.
4. Остальные микросервисы.

Если запускаем всё на локальной машине:

http://127.0.0.1:9000/pk8000/catalog/index

Иначе вызываем клиента по его IP.

